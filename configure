#!/bin/sh

undo=1
[ -f /usr/include/aspell.h -a -f /usr/include/dlfcn.h ] && spell=1
[ -f /usr/include/zlib.h ] && zlib=1

do_help() {
	echo "Optional features:"
	echo "  --enable-clang	Enable clang compiler"
	echo "  --enable-dopipes	Enable non-blocking shell commands"
	echo "  --enable-spell	Enable spell commands"
	echo "  --enable-zlib		Enable gzip compression support"
	echo "  --enable-16bitints	Enable if sizeof(int) = 2"
	echo "  --enable-sysv4	Enable if signal handlers cannot reset themselves"
	echo "  --config-dir <dir>	Default config directory."
	echo
	echo "To disable a feature replace --enable with --disable."

	exit 0
}

while [ -n "$1" ]; do
	case "$1" in
	--enable-*) enable=1;;
	--disable-*) enable=0;;
	--config-dir) ;;
	--help) do_help;;
	-h) do_help;;
	*) echo "Unknown arg '$1' ignored"; shift; continue;;
	esac

	case "$1" in
	*-clang) clang=$enable;;
	*-dopipes) dopipes=$enable;;
	*-spell) spell=$enable;;
	*-zlib) zlib=$enable;;
	*-16bitints) int16=$enable;;
	*-sysv4) sysv4=$enable;;
	--config-dir) shift; confdir=$1;;
	*) echo "Unknown arg '$1' ignored";;
	esac

	shift
done

echo "/* Generated by configure `date` */" > config.h

if [ -f /usr/include/termios.h ]; then
    echo "#define HAVE_TERMIOS" >> config.h
elif [ -f /usr/include/termio.h ]; then
    echo "#define HAVE_TERMIO" >> config.h
elif [ -f /usr/include/sgtty.h ]; then
    echo "#define HAVE_SGTTY" >> config.h
else
    echo "WARNING: No terminal setup found."
fi

[ -f /usr/include/dirent.h ] || echo "#define HAVE_DIRECT 1" >> config.h

[ "$int16" = 1 ] && echo "#define INT_IS_16BITS" >> config.h

[ "$sysv4" = 1 ] && echo "#define SYSV4" >> config.h

[ -n "$confdir" ] && echo "#define CONFIGDIR \"$confdir\"" >> config.h

set_one() {
    if [ -n "$2" ]; then
	echo "#undef $1" >> config.h
	echo "#define $1 $2" >> config.h
    fi
}

set_one DOPIPES $dopipes
set_one SPELL $spell
set_one ZLIB $zlib

if [ "$spell" = 1 ]; then
    sed 's/^#LIBS += -ldl/LIBS += -ldl/' Makefile > Makefile.tmp
else
    sed 's/^LIBS += -ldl/#LIBS += -ldl/' Makefile > Makefile.tmp
fi
mv Makefile.tmp Makefile

if [ "$zlib" = 1 ]; then
    sed 's/^#LIBS += -lz/LIBS += -lz/' Makefile > Makefile.tmp
else
    sed 's/^LIBS += -lz/#LIBS += -lz/' Makefile > Makefile.tmp
fi
mv Makefile.tmp Makefile

if [ "$clang" = 1 ]; then
    sed 's/^#CC = clang/CC = clang/' Makefile > Makefile.tmp
else
    sed 's/^CC = clang/#CC = clang/' Makefile > Makefile.tmp
fi
mv Makefile.tmp Makefile
